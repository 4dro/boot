     1                                  CPU 286
     2                                  BITS 16
     3                                  
     4                                  segment	'code'
     5                                  
     6                                  OUR_ADDRESS			equ		7C00h
     7                                  ROOT_LOAD_ADDR		equ		OUR_ADDRESS + 0A00h
     8                                  
     9                                  SEG_ADDRESS_TO_LOAD	equ		2000h
    10                                  
    11                                  var_data_start		equ	-0Ah
    12                                  cached_fat_sector	equ	-6
    13                                  var_reserved		equ	-4
    14                                  
    15 00000000 FC                                  cld
    16 00000001 EB3B                                jmp    short actual_start
    17                                  
    18                                  ; --------------- Bios Parameters Block ------------------------------------
    19 00000003 6162636465666768        os_name				db 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'
    20 0000000B 0002                    sector_size			dw 200h
    21 0000000D 01                      sec_per_cluster		db 1
    22 0000000E 0100                    reserved_sectors	dw 1
    23 00000010 02                      num_of_fats			db 2
    24 00000011 E000                    root_file_entries	dw 0E0h
    25 00000013 400B                    total_sect_low		dw 0B40h
    26 00000015 F0                      media_type			db 0F0h
    27 00000016 0900                    fat_size			dw 9
    28 00000018 1200                    sec_per_track		dw 12h
    29 0000001A 0200                    num_heads			dw 2
    30 0000001C 00000000                hidden_sectors		dd 0
    31 00000020 00000000                total_sect_large	dd 0
    32 00000024 00                      drive				db 0
    33 00000025 00                      not_used			db 0
    34 00000026 29                      nt_signature		db 29h
    35 00000027 78563412                volume_serial		dd 12345678h
    36 0000002B 202020202020202020-     disk_label			db ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '
    36 00000034 2020               
    37 00000036 4641543132202020        fs_name				db 'F', 'A', 'T', '1', '2', ' ', ' ', ' '
    38                                  
    39                                  ; ------------------------------------------------------------------------
    40                                  
    41                                  actual_start:
    42 0000003E 31C0                                xor		ax, ax
    43                                  
    44 00000040 8ED0                                mov		ss, ax
    45 00000042 BC007C                              mov		sp, OUR_ADDRESS
    46 00000045 89E5                                mov		bp, sp
    47 00000047 8EC0                                mov		es, ax
    48 00000049 8ED8                                mov		ds, ax
    49                                  
    50 0000004B B441                                mov		ah, 41h				; DISK - check ext read	support
    51 0000004D BBAA55                              mov		bx, 55AAh			; signature
    52 00000050 8856[24]                            mov		bp[byte drive], dl	; rely on drive number sent in dl
    53 00000053 CD13                                int		13h
    54 00000055 720A                                jc		short no_ext_bios
    55 00000057 80E101                              and		cl, 1
    56 0000005A 7405                                jz		short no_ext_bios
    57 0000005C C606[9B7D]42                        mov		byte [OUR_ADDRESS + bios_read_command + 2], 42h
    58                                  
    59                                  no_ext_bios:
    60                                  ; calculate data start secotor
    61 00000061 31C9                                xor		cx, cx
    62 00000063 8A46[10]                            mov		al, byte bp[byte num_of_fats]
    63 00000066 98                                  cbw
    64 00000067 F766[16]                            mul		word bp[byte fat_size]		; dx:ax - fats size in sectors
    65 0000006A 93                                  xchg	ax, bx
    66 0000006B 87D6                                xchg	dx, si						; si:bx	-> fat size in sectors
    67 0000006D 8B46[0E]                            mov		ax, word bp[byte reserved_sectors]
    68 00000070 99                                  cwd
    69 00000071 0346[1C]                            add		ax, word bp[byte hidden_sectors]
    70 00000074 1356[1E]                            adc		dx, word bp[byte hidden_sectors+2]
    71 00000077 52                                  push	dx		; put into var_reserved
    72 00000078 50                                  push	ax
    73 00000079 01D8                                add		ax, bx		; + fat size
    74 0000007B 11F2                                adc		dx, si
    75 0000007D 8B76[11]                            mov		si, word bp[byte root_file_entries]
    76 00000080 50                                  push	ax		; init cached_fat_sector with	root start sector (invalid)
    77 00000081 52                                  push	dx		; put root start (dx:ax) into var_datastart
    78 00000082 50                                  push	ax
    79 00000083 60                                  pusha
    80 00000084 96                                  xchg	ax, si
    81 00000085 99                                  cwd
    82 00000086 C1E005                              shl		ax, 5	; multiply by file entry size (32)
    83 00000089 8B5E[0B]                            mov		bx, word bp[byte sector_size]
    84 0000008C 01D8                                add		ax, bx
    85 0000008E 48                                  dec		ax
    86 0000008F F7F3                                div		bx		; calculate number of sectors needed for root folder (x + sector_size - 1) / sector size
    87 00000091 0146F6                              add		word bp[byte var_data_start], ax
    88 00000094 114EF8                              adc		word bp[byte var_data_start + 2],	cx
    89                                  
    90                                  ; calculate total number	of data	clusters
    91 00000097 8B46[13]                            mov		ax, word bp[byte total_sect_low]
    92 0000009A 0B46[20]                            or		ax, word bp[byte total_sect_large]
    93 0000009D 8B56[22]                            mov		dx, word bp[byte total_sect_large + 2]
    94 000000A0 2B46F6                              sub		ax, word bp[byte var_data_start]
    95 000000A3 1B56F8                              sbb		dx, word bp[byte var_data_start + 2]
    96 000000A6 0346[1C]                            add		ax, word bp[byte hidden_sectors]
    97 000000A9 1356[1E]                            adc		dx, word bp[byte hidden_sectors + 2]
    98 000000AC 8A4E[0D]                            mov		cl, byte bp[byte sec_per_cluster]
    99 000000AF F7F1                                div		cx		; get number of	clusters
   100                                  
   101                                  ; fat type is defined by number of clusters
   102 000000B1 3DF50F                              cmp		ax, 0FF5h
   103 000000B4 7205                                jb		short its_fat12
   104 000000B6 8006[077D]18                        add		byte [fat_type_jump	+ 1 + OUR_ADDRESS], fat16_continue - fat12_continue
   105                                  
   106                                  its_fat12:
   107 000000BB 61                                  popa		; si - number of root entries
   108                                                          ; dx:ax	- root start sector
   109                                                          ; cx - 0
   110                                  
   111                                  read_root:
   112 000000BC BB0086                              mov		bx, ROOT_LOAD_ADDR
   113 000000BF 89DF                                mov		di, bx
   114 000000C1 E8AF00                              call	read_one_sector
   115                                  
   116                                  next_file:
   117 000000C4 380D                                cmp		[di], cl
   118 000000C6 7468                                je		short file_not_found
   119 000000C8 60                                  pusha
   120 000000C9 B10B                                mov		cl, 11
   121 000000CB BE[647D]                            mov		si, loader_file_name + OUR_ADDRESS
   122 000000CE F3A6                                repe	 cmpsb
   123 000000D0 61                                  popa
   124 000000D1 740C                                je		short loader_found
   125 000000D3 4E                                  dec		si
   126 000000D4 745A                                jz		short file_not_found
   127 000000D6 83C720                              add		di, 20h
   128 000000D9 39DF                                cmp		di, bx
   129 000000DB 72E7                                jb		short next_file
   130 000000DD EBDD                                jmp		short read_root
   131                                  ; -------------------------------------------------------------------
   132                                  
   133                                  loader_found:
   134 000000DF 8B451A                              mov		ax, [di+1Ah]	; fist cluster start in	file record
   135 000000E2 BF0020                              mov		di, SEG_ADDRESS_TO_LOAD	; start	address	(segment) to load file to
   136 000000E5 57                                  push	di
   137 000000E6 51                                  push	cx
   138                                  
   139                                  read_loader_cluster:
   140 000000E7 50                                  push	ax
   141 000000E8 48                                  dec		ax
   142 000000E9 48                                  dec		ax
   143 000000EA 8A4E[0D]                            mov		cl, byte bp[byte sec_per_cluster]
   144 000000ED F7E1                                mul		cx
   145 000000EF 0346F6                              add		ax, word bp[byte var_data_start]
   146 000000F2 1356F8                              adc		dx, word bp[byte var_data_start + 2]
   147 000000F5 06                                  push	es
   148 000000F6 8EC7                                mov		es, di
   149 000000F8 31DB                                xor		bx, bx
   150 000000FA E87700                              call	read_sectors
   151 000000FD 07                                  pop		es
   152 000000FE C1EB04                              shr		bx, 4
   153 00000101 01DF                                add		di, bx
   154 00000103 58                                  pop		ax          ; ax - cluster
   155 00000104 31D2                                xor		dx, dx
   156                                  
   157                                              ; find next cluster
   158                                  fat_type_jump:
   159 00000106 EB00                                jmp		short fat12_continue
   160                                  
   161                                  fat12_continue:
   162                                              ; calculate FAT record offset on FAT12
   163 00000108 89C3                                mov		bx, ax
   164 0000010A D1EB                                shr		bx, 1
   165 0000010C 9C                                  pushf
   166 0000010D 01D8                                add		ax, bx		; ax = ax * 1.5
   167                                              ; dx is always 0 here, because maximum offset is 0FFF * 1,5 on FAT12
   168 0000010F E89F00                              call	next_cluster
   169 00000112 9D                                  popf
   170 00000113 7303                                jnc		short lower_half_byte
   171 00000115 C1E804                              shr		ax, 4
   172                                  lower_half_byte:
   173 00000118 25FF0F                              and		ax, 0FFFh
   174                                  
   175 0000011B 3DF80F                              cmp		ax, 0FF8h
   176 0000011E EB0A                                jmp		short is_last_cluster
   177                                  ; ---------------------------------------------------------------------------
   178                                  
   179                                  fat16_continue:
   180                                              ; calculate FAT record offset on FAT16
   181 00000120 01C0                                add	    ax, ax
   182 00000122 11CA                                adc	    dx, cx  ; fat offset could overflow on FAT16 - 0FFFFh * 2
   183                                  
   184 00000124 E88A00                              call    next_cluster
   185 00000127 83F8F8                              cmp     ax, 0FFF8h
   186                                  
   187                                  is_last_cluster:
   188 0000012A 72BB                                jb      short read_loader_cluster
   189 0000012C 8A56[24]                            mov     dl, bp[byte drive]
   190 0000012F CB                                  retf            ; jump to 2000:0 - start of the	loader
   191                                  ; -------------------------------------------------------------------------------
   192                                  
   193                                  file_not_found:
   194 00000130 B0[5A]                              mov		al, missing_file_msg - 100h
   195                                  
   196                                  message_exit:
   197 00000132 B47D                                mov		ah, 7Dh			; our address + 100h high byte
   198 00000134 96                                  xchg	ax, si
   199                                  
   200                                  print_char:
   201 00000135 AC                                  lodsb
   202 00000136 98                                  cbw
   203 00000137 40                                  inc		ax
   204 00000138 780C                                js		short print_replace_disk
   205 0000013A 48                                  dec		ax
   206 0000013B 7419                                jz		short wait_exit
   207 0000013D B40E                                mov		ah, 0Eh		; video	- display char and move	cursor;	al-char
   208 0000013F BB0700                              mov		bx, 7		; color	7, page	0
   209 00000142 CD10                                int		10h
   210 00000144 EBEF                                jmp		short print_char
   211                                  ; --------------------------------------------------------------------------------
   212                                  
   213                                  print_replace_disk:
   214 00000146 B0[DE]                              mov		al, replace_disk_msg - 100h ; "Replace the disk"
   215 00000148 EBE8                                jmp		short message_exit
   216                                  ; ---------------------------------------------------------------------------
   217 0000014A 0D0A4469736B206572-     disk_error_msg		db 0Dh,	0Ah, 'Disk error'
   217 00000153 726F72             
   218                                  ; ---------------------------------------------------------------------------
   219                                  
   220                                  wait_exit:
   221                                              ; ax is always 0 here
   222 00000156 CD16                                int	16h		; ah = 0, wait for a key press
   223 00000158 CD19                                int	19h		; reboot the computer
   224                                  
   225                                  ; --------------------------------------------------------------------------
   226 0000015A 0D0A4D697373696E67-     missing_file_msg	 db 0Dh, 0Ah, 'Missing '
   226 00000163 20                 
   227                                  
   228 00000164 4F534C4F4144455220-     loader_file_name	 db 'OSLOADER', 3 dup(' ')
   228 0000016D 2020               
   229                                  
   230                                  ; ---------------------------------------------------------------------------
   231                                  
   232                                  disk_error_exit:
   233 0000016F B0[4A]                              mov		al, disk_error_msg - 100h
   234 00000171 EBBF                                jmp		short message_exit
   235                                  
   236                                  ; -------------- Read one sector ------------------------------------
   237                                              ; expects cx to be 0
   238                                              ; rest parameters are the same as for read_sectors
   239                                  read_one_sector:
   240                                  
   241 00000173 41                                  inc		cx
   242                                  ; -------------- Read sectors procedure ------------------------------------
   243                                              ; es:bx	-> buffer
   244                                              ; dx:ax	- address of the sector
   245                                              ; cx - number of sectors to read
   246                                          ; on return:
   247                                              ; cx = 0
   248                                              ; dx:ax - next sector address
   249                                              ; es:bx -> adjusted to point to next address
   250                                              ; other registers are unchanged
   251                                  read_sectors:
   252                                  
   253 00000174 60                                  pusha           ; save registers
   254                                  
   255                                  ; DAP block end
   256 00000175 1E                                  push    ds		; 0
   257 00000176 1E                                  push    ds
   258 00000177 52                                  push    dx
   259 00000178 50                                  push    ax		; 8byte	absolute number	of sector
   260 00000179 06                                  push    es
   261 0000017A 53                                  push    bx		; address to read to
   262 0000017B 6A01                                push    1		; num sectors
   263 0000017D 6A10                                push    10h		; DAP block size
   264                                  ; DAP block start
   265                                  
   266                                  ; convert abs address to cylinders, heads and tracks for ah=2 bios API
   267 0000017F 91                                  xchg    ax, cx		; save lower address to	cx
   268 00000180 8B76[18]                            mov     si, word bp[byte sec_per_track]
   269 00000183 92                                  xchg    ax, dx		; higher -> ax
   270 00000184 99                                  cwd
   271                                              ; dx:ax = 0:high address
   272 00000185 F7F6                                div     si		    ; higher address / sectors per track
   273                                              ; dx = high address % sec_per_track
   274 00000187 91                                  xchg    ax, cx		; cx = high address / sec_per_track
   275                                              ; ax = low address
   276 00000188 F7F6                                div     si		    ; lower	address	/ sectors per track
   277 0000018A 87CA                                xchg    cx, dx		; cx - remainder, dx - higher result
   278                                              ; dx:ax = abs address / sec_per_track
   279                                              ; cx = abs address % sec_per_track
   280 0000018C F776[1A]                            div     word bp [byte num_heads]
   281                                              ; ax - cylinder, cx - sector, dx - head
   282 0000018F 88D6                                mov     dh, dl		; dh - head (remainder of division)
   283                                  
   284 00000191 86C4                                xchg    al, ah      ; conver cylinder into bios format
   285 00000193 C0E006                              shl     al, 6       ; bits 0-7 go to CH, 8-9 to bits 6-7 of CL
   286 00000196 41                                  inc     cx          ; inc sector number because it starts with 1
   287 00000197 09C1                                or      cx, ax
   288                                  
   289                                  bios_read_command:
   290                                              ; the following command would be replaced to "mov ax, 4201h" if extended
   291                                              ; bios read is supported
   292 00000199 B80102                              mov     ax, 201h
   293 0000019C 89E6                                mov     si, sp		; pointer to DAP packet	in stack
   294 0000019E 8A56[24]                            mov     dl, bp[byte drive]
   295                                  
   296                                      		; DISK - READ SECTORS INTO MEMORY
   297                                              ; AL = number of sectors to read, CH = track, CL = sector
   298                                              ; DH = head, DL	= drive, ES:BX -> buffer to fill
   299                                              ; Return: CF set on error, AH =	status,	AL = number of sectors read
   300 000001A1 CD13                                int     13h
   301                                  
   302 000001A3 61                                  popa    ; release DAP block from stack (same as add sp, 10h)
   303                                  
   304 000001A4 61                                  popa    ; restore all registers
   305 000001A5 72C8                                jc      short disk_error_exit
   306                                  
   307 000001A7 40                                  inc     ax		; increase read	address
   308 000001A8 7501                                jnz     short no_addr_overflow
   309 000001AA 42                                  inc     dx
   310                                  no_addr_overflow:
   311                                  
   312 000001AB 035E[0B]                            add     bx, word bp [byte sector_size]
   313 000001AE E2C4                                loop    read_sectors
   314 000001B0 C3                                  retn
   315                                  ; ----------------------------------------------------------------------------
   316                                  
   317                                  ; ----------------- Read next cluster record from FAT ------------------------------
   318                                  next_cluster:
   319                                              ; cx = 0
   320                                              ; dx:ax - byte offset of the cluster in FAT
   321                                          ; returns
   322                                              ; ax = a word from the specified offset in FAT table
   323                                              ; cx = 0
   324                                              ; bx, dx, si are changed
   325                                  
   326 000001B1 BB007E                              mov		bx, OUR_ADDRESS + 200h
   327 000001B4 F776[0B]                            div		word bp [byte sector_size]
   328 000001B7 8D7701                              lea		si, [bx+1]
   329 000001BA 01D6                                add		si, dx
   330 000001BC 99                                  cwd
   331 000001BD 0346FC                              add		ax, word bp [byte var_reserved]
   332 000001C0 1356FE                              adc		dx, word bp [byte var_reserved + 2]
   333 000001C3 3B46FA                              cmp		ax, bp [byte cached_fat_sector]
   334 000001C6 740D                                jz		short already_read
   335 000001C8 8946FA                              mov		bp [byte cached_fat_sector], ax
   336                                  
   337                                  read_one_more:
   338 000001CB E8A5FF                              call	read_one_sector
   339                                  
   340                                  take_fat_record:
   341 000001CE 39DE                                cmp     si, bx
   342 000001D0 73F9                                jae     short read_one_more
   343 000001D2 4E                                  dec		si
   344 000001D3 AD                                  lodsw			; read next cluster word
   345 000001D4 C3                                  retn
   346                                  ; ----------------------------------------------------------------------------
   347                                  
   348                                  already_read:
   349 000001D5 035E[0B]                            add		bx, word bp[byte sector_size]
   350 000001D8 40                                  inc		ax
   351 000001D9 75F3                                jnz		short take_fat_record
   352 000001DB 42                                  inc		dx
   353 000001DC EBF0                                jmp		short take_fat_record
   354                                  ; ---------------------------------------------------------------------------
   355 000001DE 0D0A5265706C616365-     replace_disk_msg	db 0Dh,0Ah,'Replace the disk',0
   355 000001E7 20746865206469736B-
   355 000001F0 00                 
   356 000001F1 44524F4F5059313233-             db 'DROOPY123456', 0
   356 000001FA 34353600           
   357 000001FE 55AA                            db 55h,	0AAh
