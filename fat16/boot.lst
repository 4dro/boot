     1                                  CPU 286
     2                                  BITS 16
     3                                  
     4                                  segment	'code'
     5                                  
     6                                  OUR_ADDRESS			equ		7C00h
     7                                  ROOT_LOAD_ADDR		equ		OUR_ADDRESS + 0A00h
     8                                  
     9                                  SEG_ADDRESS_TO_LOAD	equ		2000h
    10                                  
    11                                  var_data_start		equ	-0Ah
    12                                  cached_fat_sector	equ	-6
    13                                  var_reserved		equ	-4
    14                                  
    15 00000000 EB3C                    		jmp	short actual_start
    16                                  ; -------------------------------------------------------------------------
    17 00000002 90                      			db 90h			; nop -	not used
    18                                  
    19                                  ; --------------- Bios Parameters Block ------------------------------------
    20 00000003 6162636465666768        os_name				db 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'
    21 0000000B 0002                    sector_size			dw 200h
    22 0000000D 01                      sec_per_cluster		db 1
    23 0000000E 0100                    reserved_sectors	dw 1
    24 00000010 02                      num_of_fats			db 2
    25 00000011 E000                    root_file_entries	dw 0E0h
    26 00000013 400B                    total_sect_low		dw 0B40h
    27 00000015 F0                      media_type			db 0F0h
    28 00000016 0900                    fat_size			dw 9
    29 00000018 1200                    sec_per_track		dw 12h
    30 0000001A 0200                    num_heads			dw 2
    31 0000001C 00000000                hidden_sectors		dd 0
    32 00000020 00000000                total_sect_large	dd 0
    33 00000024 00                      drive				db 0
    34 00000025 00                      not_used			db 0
    35 00000026 29                      nt_signature		db 29h
    36 00000027 78563412                volume_serial		dd 12345678h
    37 0000002B 202020202020202020-     disk_label			db ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '
    37 00000034 2020               
    38 00000036 4641543132202020        fs_name				db 'F', 'A', 'T', '1', '2', ' ', ' ', ' '
    39                                  
    40                                  ; ------------------------------------------------------------------------
    41                                  
    42                                  actual_start:
    43 0000003E 31C9                    			xor		cx, cx
    44                                  
    45 00000040 8ED1                    			mov		ss, cx
    46 00000042 BC007C                  			mov		sp, OUR_ADDRESS
    47 00000045 89E5                    			mov		bp, sp
    48 00000047 8EC1                    			mov		es, cx
    49 00000049 8ED9                    			mov		ds, cx
    50                                  
    51 0000004B B441                    			mov		ah, 41h				; DISK - check ext read	support
    52 0000004D BBAA55                  			mov		bx, 55AAh			; signature
    53 00000050 8856[24]                			mov		bp[byte drive], dl	; rely on drive number sent in dl
    54 00000053 CD13                    			int		13h
    55 00000055 720A                    			jc		short no_ext_bios
    56 00000057 80E101                  			and		cl, 1
    57 0000005A 7405                    			jz		short no_ext_bios
    58 0000005C C606[9E7D]42            			mov		byte [OUR_ADDRESS + bios_read_command + 2], 42h
    59                                  
    60                                  no_ext_bios:
    61                                  ; calculate data start secotor
    62 00000061 31C9                    			xor		cx, cx
    63 00000063 8A46[10]                			mov		al, byte bp[byte num_of_fats]
    64 00000066 98                      			cbw
    65 00000067 FC                      			cld
    66 00000068 F766[16]                			mul		word bp[byte fat_size]		; dx:ax - fats size in sectors
    67 0000006B 93                      			xchg	ax, bx
    68 0000006C 87D6                    			xchg	dx, si						; si:bx	-> fat size in sectors
    69 0000006E 8B46[0E]                			mov		ax, word bp[byte reserved_sectors]
    70 00000071 99                      			cwd
    71 00000072 0346[1C]                			add		ax, word bp[byte hidden_sectors]
    72 00000075 1356[1E]                			adc		dx, word bp[byte hidden_sectors+2]
    73 00000078 52                      			push	dx		; put into var_reserved
    74 00000079 50                      			push	ax
    75 0000007A 01D8                    			add		ax, bx		; + fat size
    76 0000007C 11F2                    			adc		dx, si
    77 0000007E 8B76[11]                			mov		si, word bp[byte root_file_entries]
    78 00000081 50                      			push	ax		; init cached_fat_sector with	root start sector (invalid)
    79 00000082 52                      			push	dx		; put root start (dx:ax) into var_datastart
    80 00000083 50                      			push	ax
    81 00000084 60                      			pusha
    82 00000085 96                      			xchg	ax, si
    83 00000086 99                      			cwd
    84 00000087 C1E005                  			shl		ax, 5	; multiply by file entry size (32)
    85 0000008A 8B5E[0B]                			mov		bx, word bp[byte sector_size]
    86 0000008D 01D8                    			add		ax, bx
    87 0000008F 48                      			dec		ax
    88 00000090 F7F3                    			div		bx		; calculate number of sectors needed for root folder (x + sector_size - 1) / sector size
    89 00000092 0146F6                  			add		word bp[byte var_data_start], ax
    90 00000095 114EF8                  			adc		word bp[byte var_data_start + 2],	cx
    91                                  
    92                                  ; calculate total number	of data	clusters
    93 00000098 8B46[13]                			mov		ax, word bp[byte total_sect_low]
    94 0000009B 0B46[20]                			or		ax, word bp[byte total_sect_large]
    95 0000009E 8B56[22]                			mov		dx, word bp[byte total_sect_large + 2]
    96 000000A1 2B46F6                  			sub		ax, word bp[byte var_data_start]
    97 000000A4 1B56F8                  			sbb		dx, word bp[byte var_data_start + 2]
    98 000000A7 0346[1C]                			add		ax, word bp[byte hidden_sectors]
    99 000000AA 1356[1E]                			adc		dx, word bp[byte hidden_sectors + 2]
   100 000000AD 8A4E[0D]                			mov		cl, byte bp[byte sec_per_cluster]
   101 000000B0 F7F1                    			div		cx		; get number of	clusters
   102                                  
   103                                  ; fat type is defined by number of clusters
   104 000000B2 3DF50F                  			cmp		ax, 0FF5h
   105 000000B5 7205                    			jb		short its_fat12
   106 000000B7 8006[087D]19            			add		byte [fat_type_jump	+ 1 + OUR_ADDRESS], fat16_continue - fat12_continue
   107                                  
   108                                  its_fat12:
   109 000000BC 61                      			popa		; si - number of root entries
   110                                  						; dx:ax	- root start sector
   111                                  						; cx - 0
   112                                  
   113                                  read_root:
   114 000000BD BB0086                  			mov		bx, ROOT_LOAD_ADDR
   115 000000C0 89DF                    			mov		di, bx
   116 000000C2 E8B000                  			call	read_one_sector
   117                                  
   118                                  next_file:
   119 000000C5 380D                    			cmp		[di], cl
   120 000000C7 7469                    			je		short file_not_found
   121 000000C9 60                      			pusha
   122 000000CA B10B                    			mov		cl, 11
   123 000000CC BE[667D]                			mov		si, loader_file_name + OUR_ADDRESS
   124 000000CF F3A6                    			repe	 cmpsb
   125 000000D1 61                      			popa
   126 000000D2 740C                    			je		short loader_found
   127 000000D4 4E                      			dec		si
   128 000000D5 745B                    			jz		short file_not_found
   129 000000D7 83C720                  			add		di, 20h
   130 000000DA 39DF                    			cmp		di, bx
   131 000000DC 72E7                    			jb		short next_file
   132 000000DE EBDD                    			jmp		short read_root
   133                                  ; -------------------------------------------------------------------
   134                                  
   135                                  loader_found:
   136 000000E0 8B451A                  			mov		ax, [di+1Ah]	; fist cluster start in	file record
   137 000000E3 BF0020                  			mov		di, SEG_ADDRESS_TO_LOAD	; start	address	(segment) to load file to
   138 000000E6 57                      			push	di
   139 000000E7 51                      			push	cx
   140                                  
   141                                  read_loader_cluster:
   142 000000E8 50                      			push	ax
   143 000000E9 48                      			dec		ax
   144 000000EA 48                      			dec		ax
   145 000000EB 8A4E[0D]                			mov		cl, byte bp[byte sec_per_cluster]
   146 000000EE F7E1                    			mul		cx
   147 000000F0 0346F6                  			add		ax, word bp[byte var_data_start]
   148 000000F3 1356F8                  			adc		dx, word bp[byte var_data_start + 2]
   149 000000F6 06                      			push	es
   150 000000F7 8EC7                    			mov		es, di
   151 000000F9 31DB                    			xor		bx, bx
   152 000000FB E87800                  			call	read_sectors
   153 000000FE 07                      			pop		es
   154 000000FF C1EB04                  			shr		bx, 4
   155 00000102 01DF                    			add		di, bx
   156 00000104 58                      			pop		ax
   157 00000105 31D2                    			xor		dx, dx
   158                                  
   159                                  fat_type_jump:
   160 00000107 EB00                    			jmp		short fat12_continue
   161                                  
   162                                  fat12_continue:
   163 00000109 89C3                    			mov		bx, ax
   164 0000010B D1EB                    			shr		bx, 1
   165 0000010D 7308                    			jnc		short lower_half_byte
   166 0000010F E8A200                  			call	next_cluster_fat12
   167 00000112 C1E804                  			shr		ax, 4
   168 00000115 EB06                    			jmp		short check_last_fat12
   169                                  ; ------------------------------------------------------------------------
   170                                  
   171                                  lower_half_byte:
   172 00000117 E89A00                  			call	next_cluster_fat12
   173 0000011A 25FF0F                  			and		ax, 0FFFh
   174                                  
   175                                  check_last_fat12:
   176 0000011D 3DF80F                  			cmp		ax, 0FF8h
   177 00000120 EB0A                    			jmp		short is_last_cluster
   178                                  ; ---------------------------------------------------------------------------
   179                                  
   180                                  fat16_continue:
   181 00000122 01C0                    			add		ax, ax
   182 00000124 11CA                    			adc		dx, cx
   183 00000126 E88D00                  			call	next_cluster_fat16
   184 00000129 83F8F8                  			cmp		ax, 0FFF8h
   185                                  
   186                                  is_last_cluster:
   187 0000012C 72BA                    			jb		short read_loader_cluster
   188 0000012E 8A56[24]                			mov		dl, bp[byte drive]
   189 00000131 CB                      			retf			; jump to 2000:0 - start of the	loader
   190                                  ; -------------------------------------------------------------------------------
   191                                  
   192                                  file_not_found:
   193 00000132 B0[5C]                  			mov		al, missing_file_msg - 100h
   194                                  
   195                                  message_exit:
   196 00000134 B47D                    			mov		ah, 7Dh			; our address + 100h high byte
   197 00000136 96                      			xchg	ax, si
   198                                  
   199                                  print_char:
   200 00000137 AC                      			lodsb
   201 00000138 98                      			cbw
   202 00000139 40                      			inc		ax
   203 0000013A 780C                    			js		short print_replace_disk
   204 0000013C 48                      			dec		ax
   205 0000013D 7419                    			jz		short wait_exit
   206 0000013F B40E                    			mov		ah, 0Eh		; video	- display char and move	cursor;	al-char
   207 00000141 BB0700                  			mov		bx, 7		; color	7, page	0
   208 00000144 CD10                    			int		10h
   209 00000146 EBEF                    			jmp		short print_char
   210                                  ; --------------------------------------------------------------------------------
   211                                  
   212                                  print_replace_disk:
   213 00000148 B0[E3]                  			mov		al, replace_disk_msg - 100h ; "\r\nReplace the disk"
   214 0000014A EBE8                    			jmp		short message_exit
   215                                  ; ---------------------------------------------------------------------------
   216 0000014C 0D0A4469736B206572-     disk_error_msg		db 0Dh,	0Ah, 'Disk error'
   216 00000155 726F72             
   217                                  ; ---------------------------------------------------------------------------
   218                                  
   219                                  wait_exit:
   220 00000158 CD16                    			int	16h		; wait for a key press
   221 0000015A CD19                    			int	19h		; reboot the computer
   222                                  
   223                                  ; --------------------------------------------------------------------------
   224 0000015C 0D0A4D697373696E67-     missing_file_msg	 db 0Dh, 0Ah, 'Missing '
   224 00000165 20                 
   225                                  
   226 00000166 4E544C445220202020-     loader_file_name	 db 'NTLDR', 6 dup(' ')
   226 0000016F 2020               
   227                                  
   228                                  ; ---------------------------------------------------------------------------
   229                                  
   230                                  disk_error_exit:
   231 00000171 B0[4C]                  			mov		al, disk_error_msg - 100h
   232 00000173 EBBF                    			jmp		short message_exit
   233                                  
   234                                  ; -------------- Read sectors procedure ------------------------------------
   235                                  			; es:bx	-> buffer
   236                                  			; dx:ax	- address of the sector
   237                                  			; cx - number of sectors to read
   238                                  
   239                                  read_one_sector:
   240                                  
   241 00000175 41                      			inc		cx
   242                                  
   243                                  read_sectors:
   244                                  
   245 00000176 60                      			pusha
   246                                  
   247                                  ; DAP block end
   248 00000177 1E                      			push	ds		; 0
   249 00000178 1E                      			push	ds
   250 00000179 52                      			push	dx
   251 0000017A 50                      			push	ax		; 8byte	absolute number	of sector
   252 0000017B 06                      			push	es
   253 0000017C 53                      			push	bx		; address to read to
   254 0000017D 6A01                    			push	1		; num sectors
   255 0000017F 6A10                    			push	10h		; DAP block size
   256                                  ; DAP block start
   257                                  
   258                                  ; convert abs address to cylinders, heads and tracks for ah=2 bios API
   259 00000181 91                      			xchg	ax, cx		; save lower address to	cx
   260 00000182 8B46[18]                			mov		ax, word bp[byte sec_per_track]
   261 00000185 96                      			xchg	ax, si
   262 00000186 92                      			xchg	ax, dx		; higher -> ax
   263 00000187 99                      			cwd
   264 00000188 F7F6                    			div		si		; higher address / sectors per track
   265 0000018A 91                      			xchg	ax, cx		; store	higher result in cx
   266 0000018B F7F6                    			div		si		; lower	address	/ sectors per track
   267 0000018D 42                      			inc		dx
   268 0000018E 87CA                    			xchg	cx, dx		; cx - remainder + 1, dx - higher result
   269 00000190 F776[1A]                			div		word bp [byte num_heads]
   270 00000193 88D6                    			mov		dh, dl		; dh - head (remainder of division)
   271 00000195 88C5                    			mov		ch, al
   272 00000197 C0CC02                  			ror		ah, 2
   273 0000019A 08E1                    			or		cl, ah
   274                                  
   275                                  bios_read_command:
   276 0000019C B80102                  			mov		ax, 201h
   277 0000019F 89E6                    			mov		si, sp		; pointer to DAP packet	in stack
   278 000001A1 8A56[24]                			mov		dl, bp[byte drive]
   279 000001A4 CD13                    			int		13h		; DISK - READ SECTORS INTO MEMORY
   280                                  					; AL = number of sectors to read, CH = track, CL = sector
   281                                  					; DH = head, DL	= drive, ES:BX -> buffer to fill
   282                                  					; Return: CF set on error, AH =	status,	AL = number of sectors read
   283 000001A6 61                      			popa
   284 000001A7 61                      			popa
   285 000001A8 72C7                    			jc		short disk_error_exit
   286 000001AA 40                      			inc		ax		; increase read	address
   287 000001AB 7501                    			jnz		short no_addr_overflow
   288 000001AD 42                      			inc		dx
   289                                  
   290                                  no_addr_overflow:
   291 000001AE 035E[0B]                			add		bx, word bp [byte sector_size]
   292 000001B1 E2C3                    			loop	read_sectors
   293 000001B3 C3                      			retn
   294                                  ; ----------------------------------------------------------------------------
   295                                  
   296                                  next_cluster_fat12:
   297                                  
   298 000001B4 01D8                    			add		ax, bx		; ax = ax * 1.5
   299                                  
   300                                  next_cluster_fat16:
   301 000001B6 BB007E                  			mov		bx, OUR_ADDRESS + 200h
   302 000001B9 F776[0B]                			div		word bp [byte sector_size]
   303 000001BC 8D7701                  			lea		si, [bx+1]
   304 000001BF 01D6                    			add		si, dx
   305 000001C1 99                      			cwd
   306 000001C2 0346FC                  			add		ax, word bp [byte var_reserved]
   307 000001C5 1356FE                  			adc		dx, word bp [byte var_reserved + 2]
   308 000001C8 3B46FA                  			cmp		ax, bp [byte cached_fat_sector]
   309 000001CB 740D                    			jz		short already_read
   310 000001CD 8946FA                  			mov		bp [byte cached_fat_sector], ax
   311                                  
   312                                  read_one_more:
   313 000001D0 E8A2FF                  			call	read_one_sector
   314                                  
   315                                  take_fat_record:
   316 000001D3 39DE                    			cmp		si, bx
   317 000001D5 73F9                    			jnb		short read_one_more
   318 000001D7 4E                      			dec		si
   319 000001D8 AD                      			lodsw			; read next cluster word
   320 000001D9 C3                      			retn
   321                                  ; ----------------------------------------------------------------------------
   322                                  
   323                                  already_read:
   324 000001DA 035E[0B]                			add		bx, word bp[byte sector_size]
   325 000001DD 40                      			inc		ax
   326 000001DE 75F3                    			jnz		short take_fat_record
   327 000001E0 42                      			inc		dx
   328 000001E1 EBF0                    			jmp		short take_fat_record
   329                                  ; ---------------------------------------------------------------------------
   330 000001E3 0D0A5265706C616365-     replace_disk_msg	db 0Dh,0Ah,'Replace the disk',0
   330 000001EC 20746865206469736B-
   330 000001F5 00                 
   331 000001F6 44524F4F50593100        		db 'DROOPY1', 0
   332 000001FE 55AA                    		db 55h,	0AAh
