     1                                  CPU 286
     2                                  BITS 16
     3                                  
     4                                  segment	'code'
     5                                  
     6                                  OUR_ADDRESS			equ		7C00h
     7                                  SEG_ADDRESS_TO_LOAD	equ		2000h
     8                                  
     9                                  var_data_start		equ	-0Ah
    10                                  var_last_fat_sector	equ	-6
    11                                  var_reserved		equ	-4
    12                                  
    13 00000000 EB3C                    		jmp	short actual_start
    14                                  ; -------------------------------------------------------------------------
    15 00000002 90                      			db 90h			; nop -	not used
    16                                  
    17                                  ; --------------- Bios Parameters Block ------------------------------------
    18 00000003 6162636465666768        os_name				db 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'
    19 0000000B 0002                    sector_size			dw 200h
    20 0000000D 01                      sec_per_cluster		db 1
    21 0000000E 0100                    reserved_sectors	dw 1
    22 00000010 02                      num_of_fats			db 2
    23 00000011 E000                    root_file_entries	dw 0E0h
    24 00000013 400B                    total_sect_low		dw 0B40h
    25 00000015 F0                      media_type			db 0F0h
    26 00000016 0900                    fat_size			dw 9
    27 00000018 1200                    sec_per_track		dw 12h
    28 0000001A 0200                    num_heads			dw 2
    29 0000001C 00000000                hidden_sectors		dd 0
    30 00000020 00000000                total_sect_large	dd 0
    31 00000024 00                      drive				db 0
    32 00000025 00                      not_used			db 0
    33 00000026 29                      nt_signature		db 29h
    34 00000027 78563412                volume_serial		dd 12345678h
    35 0000002B 202020202020202020-     disk_label			db ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '
    35 00000034 2020               
    36 00000036 4641543132202020        fs_name				db 'F', 'A', 'T', '1', '2', ' ', ' ', ' '
    37                                  
    38                                  ; ------------------------------------------------------------------------
    39                                  
    40                                  actual_start:
    41 0000003E 31C9                    			xor	cx, cx
    42                                  
    43 00000040 8ED1                    			mov		ss, cx
    44 00000042 BC007C                  			mov		sp, OUR_ADDRESS
    45 00000045 89E5                    			mov		bp, sp
    46 00000047 8EC1                    			mov		es, cx
    47 00000049 8ED9                    			mov		ds, cx
    48                                  
    49 0000004B B441                    			mov		ah, 41h				; DISK - check ext read	support
    50 0000004D BBAA55                  			mov		bx, 55AAh			; signature
    51 00000050 8856[24]                			mov		bp[byte drive], dl	; rely on drive number sent in dl
    52 00000053 CD13                    			int		13h
    53 00000055 720A                    			jc		short no_ext_bios
    54 00000057 80E101                  			and		cl, 1
    55 0000005A 7405                    			jz		short no_ext_bios
    56 0000005C C606[9E7D]42            			mov		byte [OUR_ADDRESS + bios_read_command + 2], 42h
    57                                  
    58                                  no_ext_bios:
    59                                  ; calculate data start secotor
    60 00000061 31C9                    			xor		cx, cx
    61 00000063 8A46[10]                			mov		al, byte bp[byte num_of_fats]
    62 00000066 98                      			cbw
    63 00000067 FC                      			cld
    64 00000068 F766[16]                			mul		word bp[byte fat_size]		; dx:ax - fats size in sectors
    65 0000006B 93                      			xchg	ax, bx
    66 0000006C 87D6                    			xchg	dx, si						; si:bx	-> fat size in sectors
    67 0000006E 8B46[0E]                			mov		ax, word bp[byte reserved_sectors]
    68 00000071 99                      			cwd
    69 00000072 0346[1C]                			add		ax, word bp[byte hidden_sectors]
    70 00000075 1356[1E]                			adc		dx, word bp[byte hidden_sectors+2]
    71 00000078 52                      			push	dx		; put into var_reserved
    72 00000079 50                      			push	ax
    73 0000007A 01D8                    			add		ax, bx		; + fat size
    74 0000007C 11F2                    			adc		dx, si
    75 0000007E 8B76[11]                			mov		si, word bp[byte root_file_entries]
    76 00000081 50                      			push	ax		; init var_last_fat_sector with	root start sector (invalid)
    77 00000082 52                      			push	dx		; put root start (dx:ax) into var_datastart
    78 00000083 50                      			push	ax
    79 00000084 60                      			pusha
    80 00000085 96                      			xchg	ax, si
    81 00000086 99                      			cwd
    82 00000087 C1E005                  			shl		ax, 5	; multiply by file entry size (32)
    83 0000008A 8B5E[0B]                			mov		bx, word bp[byte sector_size]
    84 0000008D 01D8                    			add		ax, bx
    85 0000008F 48                      			dec		ax
    86 00000090 F7F3                    			div		bx		; calculate number of sectors needed for root folder (x + sector_size - 1) / sector size
    87 00000092 0146F6                  			add		word bp[byte var_data_start], ax
    88 00000095 114EF8                  			adc		word bp[byte var_data_start + 2],	cx
    89                                  
    90                                  ; calculate total number	of data	clusters
    91 00000098 8B46[13]                			mov		ax, word bp[byte total_sect_low]
    92 0000009B 0B46[20]                			or		ax, word bp[byte total_sect_large]
    93 0000009E 8B56[22]                			mov		dx, word bp[byte total_sect_large + 2]
    94 000000A1 2B46F6                  			sub		ax, word bp[byte var_data_start]
    95 000000A4 1B56F8                  			sbb		dx, word bp[byte var_data_start + 2]
    96 000000A7 0346[1C]                			add		ax, word bp[byte hidden_sectors]
    97 000000AA 1356[1E]                			adc		dx, word bp[byte hidden_sectors + 2]
    98 000000AD 8A4E[0D]                			mov		cl, byte bp[byte sec_per_cluster]
    99 000000B0 F7F1                    			div		cx		; get number of	clusters
   100                                  
   101                                  ; fat type is defined by number of clusters
   102 000000B2 3DF50F                  			cmp		ax, 0FF5h
   103 000000B5 7205                    			jb		short its_fat12
   104 000000B7 8006[087D]19            			add		byte [fat_type_jump	+ 1 + OUR_ADDRESS], fat16_continue - fat12_continue
   105                                  
   106                                  its_fat12:
   107 000000BC 61                      			popa		; si - number of root entries
   108                                  						; dx:ax	- root start sector
   109                                  						; cx - 0
   110                                  
   111                                  read_root:
   112 000000BD BB0086                  			mov		bx, 8600h
   113 000000C0 89DF                    			mov		di, bx
   114 000000C2 E8B000                  			call	read_one_sector
   115                                  
   116                                  next_file:
   117 000000C5 380D                    			cmp		[di], cl
   118 000000C7 7469                    			je		short file_not_found
   119 000000C9 60                      			pusha
   120 000000CA B10B                    			mov		cl, 11
   121 000000CC BE[667D]                			mov		si, loader_file_name + OUR_ADDRESS
   122 000000CF F3A6                    			repe	 cmpsb
   123 000000D1 61                      			popa
   124 000000D2 740C                    			je		short loader_found
   125 000000D4 4E                      			dec		si
   126 000000D5 745B                    			jz		short file_not_found
   127 000000D7 83C720                  			add		di, 20h
   128 000000DA 39DF                    			cmp		di, bx
   129 000000DC 72E7                    			jb		short next_file
   130 000000DE EBDD                    			jmp		short read_root
   131                                  ; -------------------------------------------------------------------
   132                                  
   133                                  loader_found:
   134 000000E0 8B451A                  			mov		ax, [di+1Ah]	; fist cluster start in	file record
   135 000000E3 BF0020                  			mov		di, SEG_ADDRESS_TO_LOAD	; start	address	(segment) to load file to
   136 000000E6 57                      			push	di
   137 000000E7 51                      			push	cx
   138                                  
   139                                  read_loader_cluster:
   140 000000E8 50                      			push	ax
   141 000000E9 48                      			dec		ax
   142 000000EA 48                      			dec		ax
   143 000000EB 8A4E[0D]                			mov		cl, byte bp[byte sec_per_cluster]
   144 000000EE F7E1                    			mul		cx
   145 000000F0 0346F6                  			add		ax, word bp[byte var_data_start]
   146 000000F3 1356F8                  			adc		dx, word bp[byte var_data_start + 2]
   147 000000F6 06                      			push	es
   148 000000F7 8EC7                    			mov		es, di
   149 000000F9 31DB                    			xor		bx, bx
   150 000000FB E87800                  			call	read_sectors
   151 000000FE 07                      			pop		es
   152 000000FF C1EB04                  			shr		bx, 4
   153 00000102 01DF                    			add		di, bx
   154 00000104 58                      			pop		ax
   155 00000105 31D2                    			xor		dx, dx
   156                                  
   157                                  fat_type_jump:
   158 00000107 EB00                    			jmp		short fat12_continue
   159                                  
   160                                  fat12_continue:
   161 00000109 89C3                    			mov		bx, ax
   162 0000010B D1EB                    			shr		bx, 1
   163 0000010D 7308                    			jnc		short lower_half_byte
   164 0000010F E8A200                  			call	next_cluster_fat12
   165 00000112 C1E804                  			shr		ax, 4
   166 00000115 EB06                    			jmp		short check_last_fat12
   167                                  ; ------------------------------------------------------------------------
   168                                  
   169                                  lower_half_byte:
   170 00000117 E89A00                  			call	next_cluster_fat12
   171 0000011A 25FF0F                  			and		ax, 0FFFh
   172                                  
   173                                  check_last_fat12:
   174 0000011D 3DF80F                  			cmp		ax, 0FF8h
   175 00000120 EB0A                    			jmp		short is_last_cluster
   176                                  ; ---------------------------------------------------------------------------
   177                                  
   178                                  fat16_continue:
   179 00000122 01C0                    			add		ax, ax
   180 00000124 11CA                    			adc		dx, cx
   181 00000126 E88D00                  			call	next_cluster_fat16
   182 00000129 83F8F8                  			cmp		ax, 0FFF8h
   183                                  
   184                                  is_last_cluster:
   185 0000012C 72BA                    			jb		short read_loader_cluster
   186 0000012E 8A56[24]                			mov		dl, bp[byte drive]
   187 00000131 CB                      			retf			; jump to 2000:0 - start of the	loader
   188                                  ; -------------------------------------------------------------------------------
   189                                  
   190                                  file_not_found:
   191 00000132 B0[5C]                  			mov		al, missing_file_msg - 100h
   192                                  
   193                                  message_exit:
   194 00000134 B47D                    			mov		ah, 7Dh			; our address + 100h high byte
   195 00000136 96                      			xchg	ax, si
   196                                  
   197                                  print_char:
   198 00000137 AC                      			lodsb
   199 00000138 98                      			cbw
   200 00000139 40                      			inc		ax
   201 0000013A 780C                    			js		short print_replace_disk
   202 0000013C 48                      			dec		ax
   203 0000013D 7419                    			jz		short wait_exit
   204 0000013F B40E                    			mov		ah, 0Eh		; video	- display char and move	cursor;	al-char
   205 00000141 BB0700                  			mov		bx, 7		; color	7, page	0
   206 00000144 CD10                    			int		10h
   207 00000146 EBEF                    			jmp		short print_char
   208                                  ; --------------------------------------------------------------------------------
   209                                  
   210                                  print_replace_disk:
   211 00000148 B0[E3]                  			mov		al, replace_disk_msg - 100h ; "\r\nReplace the disk"
   212 0000014A EBE8                    			jmp		short message_exit
   213                                  ; ---------------------------------------------------------------------------
   214 0000014C 0D0A4469736B206572-     disk_error_msg		db 0Dh,	0Ah, 'Disk error'
   214 00000155 726F72             
   215                                  ; ---------------------------------------------------------------------------
   216                                  
   217                                  wait_exit:
   218 00000158 CD16                    			int	16h		; KEYBOARD -
   219 0000015A CD19                    			int	19h		; DISK BOOT
   220                                  					; causes reboot	of disk	system
   221                                  ; --------------------------------------------------------------------------
   222 0000015C 0D0A4D697373696E67-     missing_file_msg	 db 0Dh, 0Ah, 'Missing '
   222 00000165 20                 
   223                                  
   224 00000166 4E544C445220202020-     loader_file_name	 db 'NTLDR', 6 dup(' ')
   224 0000016F 2020               
   225                                  
   226                                  ; ---------------------------------------------------------------------------
   227                                  
   228                                  disk_error_exit:
   229 00000171 B0[4C]                  			mov		al, disk_error_msg - 100h
   230 00000173 EBBF                    			jmp		short message_exit
   231                                  ; --------------------------------------------------------------------------
   232                                  
   233                                  read_one_sector:
   234                                  
   235 00000175 41                      			inc		cx
   236                                  
   237                                  read_sectors:
   238 00000176 60                      			pusha			; Read one sector:
   239                                  						; es:bx	-> buffer
   240                                  						; dx:ax	- address of the sector
   241                                  						; cx - number of sectors to read
   242 00000177 1E                      			push	ds
   243 00000178 1E                      			push	ds
   244 00000179 52                      			push	dx
   245 0000017A 50                      			push	ax		; 8byte	absolute number	of sector
   246 0000017B 06                      			push	es
   247 0000017C 53                      			push	bx		; address to read to
   248 0000017D 6A01                    			push	1		; num sectors
   249 0000017F 6A10                    			push	10h		; 42h -	stucture size
   250                                  					; DAP block
   251 00000181 91                      			xchg	ax, cx		; save lower address to	cx
   252 00000182 8B46[18]                			mov		ax, word bp[byte sec_per_track]
   253 00000185 96                      			xchg	ax, si
   254 00000186 92                      			xchg	ax, dx		; higher -> ax
   255 00000187 99                      			cwd
   256 00000188 F7F6                    			div		si		; higher address / sectors per track
   257 0000018A 91                      			xchg	ax, cx		; store	higher result in cx
   258 0000018B F7F6                    			div		si		; lower	address	/ sectors per track
   259 0000018D 42                      			inc		dx
   260 0000018E 87CA                    			xchg	cx, dx		; cx - remainder + 1, dx - higher result
   261 00000190 F776[1A]                			div		word bp[byte num_heads]
   262 00000193 88D6                    			mov		dh, dl		; dh - head (remainder of division)
   263 00000195 88C5                    			mov		ch, al
   264 00000197 C0CC02                  			ror		ah, 2
   265 0000019A 08E1                    			or		cl, ah
   266                                  
   267                                  bios_read_command:
   268 0000019C B80102                  			mov		ax, 201h
   269 0000019F 89E6                    			mov		si, sp		; pointer to DAP packet	in stack
   270 000001A1 8A56[24]                			mov		dl, bp[byte drive]
   271 000001A4 CD13                    			int		13h		; DISK - READ SECTORS INTO MEMORY
   272                                  					; AL = number of sectors to read, CH = track, CL = sector
   273                                  					; DH = head, DL	= drive, ES:BX -> buffer to fill
   274                                  					; Return: CF set on error, AH =	status,	AL = number of sectors read
   275 000001A6 61                      			popa
   276 000001A7 61                      			popa
   277 000001A8 72C7                    			jb		short disk_error_exit
   278 000001AA 40                      			inc		ax		; increase read	address
   279 000001AB 7501                    			jnz		short no_addr_overflow
   280 000001AD 42                      			inc		dx
   281                                  
   282                                  no_addr_overflow:
   283 000001AE 035E[0B]                			add		bx, word bp[byte sector_size]
   284 000001B1 E2C3                    			loop	read_sectors
   285 000001B3 C3                      			retn
   286                                  ; ----------------------------------------------------------------------------
   287                                  
   288                                  next_cluster_fat12:
   289                                  
   290 000001B4 01D8                    			add		ax, bx		; bx = ax / 2
   291                                  
   292                                  next_cluster_fat16:
   293 000001B6 BB007E                  			mov		bx, OUR_ADDRESS + 200h
   294 000001B9 F776[0B]                			div		word bp[byte sector_size]
   295 000001BC 8D7701                  			lea		si, [bx+1]
   296 000001BF 01D6                    			add		si, dx
   297 000001C1 99                      			cwd
   298 000001C2 0346FC                  			add		ax, word bp[byte var_reserved]
   299 000001C5 1356FE                  			adc		dx, word bp[byte var_reserved + 2]
   300 000001C8 3B46FA                  			cmp		ax, bp[byte var_last_fat_sector]
   301 000001CB 740D                    			jz		short already_read
   302 000001CD 8946FA                  			mov		bp[byte var_last_fat_sector], ax
   303                                  
   304                                  read_one_more:
   305 000001D0 E8A2FF                  			call	read_one_sector
   306                                  
   307                                  take_fat_record:
   308 000001D3 39DE                    			cmp		si, bx
   309 000001D5 73F9                    			jnb		short read_one_more
   310 000001D7 4E                      			dec		si
   311 000001D8 AD                      			lodsw			; read next cluster word
   312 000001D9 C3                      			retn
   313                                  ; ----------------------------------------------------------------------------
   314                                  
   315                                  already_read:
   316 000001DA 035E[0B]                			add		bx, word bp[byte sector_size]
   317 000001DD 40                      			inc		ax
   318 000001DE 75F3                    			jnz		short take_fat_record
   319 000001E0 42                      			inc		dx
   320 000001E1 EBF0                    			jmp		short take_fat_record
   321                                  ; ---------------------------------------------------------------------------
   322 000001E3 0D0A5265706C616365-     replace_disk_msg	db 0Dh,0Ah,'Replace the disk',0
   322 000001EC 20746865206469736B-
   322 000001F5 00                 
   323 000001F6 44524F4F50593100        		db 'DROOPY1', 0
   324 000001FE 55AA                    		db 55h,	0AAh
